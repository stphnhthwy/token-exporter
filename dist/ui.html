<!DOCTYPE html>
<html>
<head>
    <title>Token Exporter</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        button {
            margin-top: 12px;
            padding: 8px 16px;
            background-color: #18A0FB;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1089d9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 10px;
            color: #333;
        }
        .radio-group {
            margin: 12px 0;
        }
        .radio-option {
            margin-bottom: 8px;
        }
        label {
            margin-left: 6px;
        }
        #collections-list {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 8px;
            display: none;
        }
        .collection-item {
            margin-bottom: 8px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collection-name {
            font-weight: bold;
        }
        .download-link {
            color: #18A0FB;
            text-decoration: none;
            cursor: pointer;
        }
        .download-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div>
        <h3>Export Variables</h3>
        
        <div class="radio-group">
            <div class="radio-option">
                <input type="radio" id="singleFile" name="exportMode" value="single" checked>
                <label for="singleFile">Single JSON File</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="multipleFiles" name="exportMode" value="multiple">
                <label for="multipleFiles">Multiple Individual Files</label>
            </div>
            <div class="radio-option">
                <input type="radio" id="zipFile" name="exportMode" value="zip">
                <label for="zipFile">ZIP File (All Collections)</label>
            </div>
        </div>
        
        <button id="exportBtn">Export Variables</button>
        <div id="status"></div>
        
        <div id="collections-list"></div>
    </div>
    
    <!-- Load JSZip library dynamically when needed -->
    <script>
        // Function to load JSZip library
        function loadJSZip() {
            return new Promise((resolve, reject) => {
                if (window.JSZip) {
                    resolve(window.JSZip);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = () => resolve(window.JSZip);
                script.onerror = () => reject(new Error('Failed to load JSZip'));
                document.head.appendChild(script);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const exportBtn = document.getElementById('exportBtn');
            const status = document.getElementById('status');
            const collectionsList = document.getElementById('collections-list');
            
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    status.textContent = "Processing...";
                    exportBtn.disabled = true;
                    collectionsList.style.display = 'none';
                    collectionsList.innerHTML = '';
                    
                    // Get the selected export mode
                    const exportMode = document.querySelector('input[name="exportMode"]:checked').value;
                    
                    parent.postMessage({ 
                        pluginMessage: { 
                            type: "export-variables",
                            exportMode: exportMode
                        } 
                    }, "*");
                });
            }

            window.addEventListener('message', async (event) => {
                const msg = event.data.pluginMessage;
                if (!msg) return;
                
                if (msg.type === "download") {
                    status.textContent = "Creating download...";
                    
                    try {
                        // Create blob from the data
                        const blob = new Blob([msg.data], { type: "application/json" });
                        
                        // Create object URL
                        const url = URL.createObjectURL(blob);
                        
                        // Create download link
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = msg.filename || "figma-variables.json";
                        a.style.display = "none";
                        
                        // Add to DOM, click, and remove
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            status.textContent = "Download complete!";
                            exportBtn.disabled = false;
                        }, 100);
                    } catch (error) {
                        console.error("Download error:", error);
                        status.textContent = "Error: " + error.message;
                        exportBtn.disabled = false;
                    }
                }
                else if (msg.type === "multiple-collections") {
                    status.textContent = `Ready to download ${msg.collections.length} collections`;
                    collectionsList.style.display = 'block';
                    collectionsList.innerHTML = '';
                    exportBtn.disabled = false;
                    
                    // Create individual collection items
                    msg.collections.forEach(collection => {
                        const item = document.createElement('div');
                        item.className = 'collection-item';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'collection-name';
                        nameSpan.textContent = collection.name;
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.className = 'download-link';
                        downloadLink.textContent = 'Download';
                        downloadLink.addEventListener('click', () => {
                            downloadCollection(collection);
                        });
                        
                        item.appendChild(nameSpan);
                        item.appendChild(downloadLink);
                        collectionsList.appendChild(item);
                    });
                }
                else if (msg.type === "create-zip") {
                    status.textContent = "Creating ZIP file...";
                    
                    try {
                        // Load JSZip library
                        const JSZip = await loadJSZip();
                        const zip = new JSZip();
                        
                        // Add each collection to the zip
                        msg.collections.forEach(collection => {
                            zip.file(collection.filename, collection.data);
                        });
                        
                        // Generate the zip file
                        status.textContent = "Generating ZIP file...";
                        const zipBlob = await zip.generateAsync({ type: 'blob' });
                        
                        // Create download link for the zip
                        const url = URL.createObjectURL(zipBlob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "figma-variables-collections.zip";
                        a.style.display = "none";
                        
                        // Add to DOM, click, and remove
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            status.textContent = "ZIP download complete!";
                            exportBtn.disabled = false;
                        }, 100);
                    } catch (error) {
                        console.error("ZIP creation error:", error);
                        status.textContent = "Error creating ZIP: " + error.message;
                        exportBtn.disabled = false;
                    }
                }
            });
            
            // Helper function to download a collection
            function downloadCollection(collection) {
                try {
                    const blob = new Blob([collection.data], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = collection.filename;
                    a.style.display = "none";
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                } catch (error) {
                    console.error("Download error:", error);
                    status.textContent = "Error: " + error.message;
                }
            }
        });
    </script>
</body>
</html> 